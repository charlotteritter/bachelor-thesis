GAMS 24.8.5  r61358 Released May 10, 2017 LEX-LEG x86 64bit/Linux                                                                                                                                                                      05/09/21 13:29:41 Page 1
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
C o m p i l a t i o n


      Bismark Singh
      March 17, 2021
       
      Code for plain Lagrangian decomposition (removed Progressive Hedging)
      Based on the paper at http://www.optimization-online.org/DB_HTML/2019/05/7222.html
       
       
      Excel file used for LB heuristic needs to be manually sorted
       
  12   
  14  OPTIONS PROFILE =3, RESLIM   = 2100, LIMROW   = 5, LP = CPLEX, MIP = cplex, RMIP=cplex, NLP = CONOPT, MINLP = DICOPT, MIQCP = CPLEX, SOLPRINT = OFF, decimals = 8, optcr=0.001, optca=0.001, threads =8, integer4=0;
  15   
  16  ********************************************************************************
  17  *                                Include input files
  18  ********************************************************************************
INCLUDE    /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/inputME.gms
  20  ** sets later to be defined in input file
  21   
  22  ** to be changed
  23   
  24  SETS T times/t1*t24/;
  25   
  26  * Number of scenarios
  27  *SETS SCEN scenarios /scen1*%MAXSCEN%/;
  28  SETS SCEN scenarios /scen1*scen100/;
  29   
  30  TABLE Solar(scen,t)
  32  *$INCLUDE %SOLAR%.csv
  33  $INCLUDE solar_scenarios_100_2.csv
****                                   $282
**** LINE     14 INCLUDE     /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/inputME.gms
**** LINE     19 INPUT       /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/TestLoop.gms
  35  ;
****  $463
**** LINE     16 INCLUDE     /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/inputME.gms
**** LINE     19 INPUT       /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/TestLoop.gms
  36   
  37  *Tolerance
  38  scalar tol;
  39  *tol=%TOL%;
  40  tol=0.01;
  41   
  42  * maximum number of iterations in LR
  43  set iter number of subgradient iterations /iter1*iter10/;
  44   
  45  * time limit for each problem
  46  scalar time_limit;
  47  *time_limit=%TIMELIM%;
  48  time_limit=2250;
  49   
  50   
  51  * Import the SORTED file
  52  table scenario_sorted(scen,*)
GAMS 24.8.5  r61358 Released May 10, 2017 LEX-LEG x86 64bit/Linux                                                                                                                                                                      05/09/21 13:29:41 Page 2
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
C o m p i l a t i o n


  54  *$INCLUDE %SORTEDFILE%.csv
  55  *$INCLUDE scenario_sorted_100_1_01.csv
INCLUDE    /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/scenario_sorted_100_2_01.csv
  57   ,value
  58  scen76,1
  59  scen97,0
  60  scen69,0
  61  scen87,0
  62  scen81,0
  63  scen96,0
  64  scen100,0
  65  scen75,0
  66  scen10,0
  67  scen99,0
  68  scen20,0
  69  scen53,0
  70  scen58,0
  71  scen23,0
  72  scen16,0
  73  scen15,0
  74  scen77,0
  75  scen83,0
  76  scen17,0
  77  scen41,0
  78  scen54,0
  79  scen46,0
  80  scen91,0
  81  scen3,0
  82  scen5,0
  83  scen40,0
  84  scen42,0
  85  scen35,0
  86  scen82,0
  87  scen84,0
  88  scen47,0
  89  scen71,0
  90  scen73,0
  91  scen55,0
  92  scen2,0
  93  scen86,0
  94  scen8,0
  95  scen66,0
  96  scen49,0
  97  scen32,0
  98  scen52,0
  99  scen98,0
 100  scen4,0
 101  scen21,0
 102  scen68,0
 103  scen6,0
 104  scen28,0
 105  scen72,0
 106  scen34,0
GAMS 24.8.5  r61358 Released May 10, 2017 LEX-LEG x86 64bit/Linux                                                                                                                                                                      05/09/21 13:29:41 Page 3
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
C o m p i l a t i o n


 107  scen43,0
 108  scen30,0
 109  scen63,0
 110  scen7,0
 111  scen39,0
 112  scen48,0
 113  scen44,0
 114  scen78,0
 115  scen31,0
 116  scen92,0
 117  scen36,0
 118  scen1,0
 119  scen70,0
 120  scen57,0
 121  scen65,0
 122  scen11,0
 123  scen79,0
 124  scen14,0
 125  scen62,0
 126  scen12,0
 127  scen27,0
 128  scen18,0
 129  scen22,0
 130  scen60,0
 131  scen50,0
 132  scen13,0
 133  scen25,0
 134  scen61,0
 135  scen95,0
 136  scen56,0
 137  scen80,0
 138  scen94,0
 139  scen90,0
 140  scen37,0
 141  scen93,0
 142  scen89,0
 143  scen67,0
 144  scen29,0
 145  scen59,0
 146  scen33,0
 147  scen45,0
 148  scen64,0
 149  scen88,0
 150  scen24,0
 151  scen74,0
 152  scen51,0
 153  scen9,0
 154  scen38,0
 155  scen26,0
 156  scen85,0
 157  scen19,0
 158  *$INCLUDE scenario_sorted_100_3_01.csv
 159  *$INCLUDE scenario_sorted_100_4_01.csv
GAMS 24.8.5  r61358 Released May 10, 2017 LEX-LEG x86 64bit/Linux                                                                                                                                                                      05/09/21 13:29:41 Page 4
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
C o m p i l a t i o n


 160  *$INCLUDE scenario_sorted_100_5_01.csv
 161  *$INCLUDE scenario_sorted_100_6_01.csv
 162  *$INCLUDE scenario_sorted_100_7_01.csv
 163  *$INCLUDE scenario_sorted_100_8_01.csv
 164  *$INCLUDE scenario_sorted_100_9_01.csv
 165  *$INCLUDE scenario_sorted_100_10_01.csv
 166  *$INCLUDE scenario_sorted_100_11_01.csv
 167  *$INCLUDE scenario_sorted_100_12_01.csv
 168  *$INCLUDE scenario_sorted_100_13_01.csv
 169  *$INCLUDE scenario_sorted_100_14_01.csv
 170  *$INCLUDE scenario_sorted_100_15_01.csv
 171  *$INCLUDE scenario_sorted_100_16_01.csv
 172  *$INCLUDE scenario_sorted_100_17_01.csv
 173  *$INCLUDE scenario_sorted_100_18_01.csv
 174  *$INCLUDE scenario_sorted_100_19_01.csv
 175  *$INCLUDE scenario_sorted_100_20_01.csv
 176  *$INCLUDE scenario_sorted_100_1_05.csv
 177  *$INCLUDE scenario_sorted_100_2_05.csv
 178  *$INCLUDE scenario_sorted_100_3_05.csv
 179  *$INCLUDE scenario_sorted_100_4_05.csv
 180  *$INCLUDE scenario_sorted_100_5_05.csv
 181  *$INCLUDE scenario_sorted_100_6_05.csv
 182  *$INCLUDE scenario_sorted_100_7_05.csv
 183  *$INCLUDE scenario_sorted_100_8_05.csv
 184  *$INCLUDE scenario_sorted_100_9_05.csv
 185  *$INCLUDE scenario_sorted_100_10_05.csv
 186  *$INCLUDE scenario_sorted_100_11_05.csv
 187  *$INCLUDE scenario_sorted_100_12_05.csv
 188  *$INCLUDE scenario_sorted_100_13_05.csv
 189  *$INCLUDE scenario_sorted_100_14_05.csv
 190  *$INCLUDE scenario_sorted_100_15_05.csv
 191  *$INCLUDE scenario_sorted_100_16_05.csv
 192  *$INCLUDE scenario_sorted_100_17_05.csv
 193  *$INCLUDE scenario_sorted_100_18_05.csv
 194  *$INCLUDE scenario_sorted_100_19_05.csv
 195  *$INCLUDE scenario_sorted_100_20_05.csv
 196  *$INCLUDE scenario_sorted_150_01.csv
 197  *$INCLUDE scenario_sorted_150_03.csv
 198  *$INCLUDE scenario_sorted_150_05.csv
 199  *$INCLUDE scenario_sorted_300_01.csv
 200  *$INCLUDE scenario_sorted_300_03.csv
 201  *$INCLUDE scenario_sorted_300_05.csv
 202  *$INCLUDE scenario_sorted_450_01.csv
 203  *$INCLUDE scenario_sorted_450_03.csv
 204  *$INCLUDE scenario_sorted_450_05.csv
 205  *$INCLUDE scenario_sorted_600_01.csv
 206  *$INCLUDE scenario_sorted_600_05.csv
 207  *$INCLUDE scenario_sorted_600_03.csv
 208  *$INCLUDE scenario_sorted_900_01.csv
 209  *$INCLUDE scenario_sorted_900_03.csv
 210  *$INCLUDE scenario_sorted_900_05.csv
 211  *$INCLUDE scenario_sorted_1200_01.csv
 212  *$INCLUDE scenario_sorted_1200_03.csv
GAMS 24.8.5  r61358 Released May 10, 2017 LEX-LEG x86 64bit/Linux                                                                                                                                                                      05/09/21 13:29:41 Page 5
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
C o m p i l a t i o n


 213  *$INCLUDE scenario_sorted_1200_05.csv
 214  *$INCLUDE scenario_sorted_2400_01.csv
 215  *$INCLUDE scenario_sorted_2400_05.csv
 217  ;
 218   
 219   
 220   
 221   
 222   
 223  ALIAS (T,TT);
 224  alias(scen,i);
 225   
 226  scalar n;
 227  n=card(scen);
 228   
 229  *Scalar which tells if LR converges
 230  scalar convergence;
 231   
 232  ** define battery  operation costs costs and solar selling prices
 233   
 234  TABLE PRICES(t,*)
INCLUDE    /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/battery_revenue.csv
 237  ,REW,CHAR,DISCH
 238  t1,0.018872128,0.025641026,0.025641026
 239  t2,0.017165378,0.025641026,0.025641026
 240  t3,0.015479861,0.025641026,0.025641026
 241  t4,0.014815148,0.025641026,0.025641026
 242  t5,0.014640477,0.025641026,0.025641026
 243  t6,0.015101974,0.025641026,0.025641026
 244  t7,0.017323907,0.025641026,0.025641026
 245  t8,0.021866318,0.025641026,0.025641026
 246  t9,0.022687626,0.025641026,0.025641026
 247  t10,0.022632312,0.025641026,0.025641026
 248  t11,0.023539775,0.025641026,0.025641026
 249  t12,0.024153055,0.025641026,0.025641026
 250  t13,0.025002242,0.025641026,0.025641026
 251  t14,0.026148843,0.025641026,0.025641026
 252  t15,0.028482657,0.025641026,0.025641026
 253  t16,0.035324217,0.025641026,0.025641026
 254  t17,0.053079881,0.025641026,0.025641026
 255  t18,0.067077457,0.025641026,0.025641026
 256  t19,0.043782645,0.025641026,0.025641026
 257  t20,0.033252185,0.025641026,0.025641026
 258  t21,0.02868827,0.025641026,0.025641026
 259  t22,0.026761757,0.025641026,0.025641026
 260  t23,0.023974723,0.025641026,0.025641026
 261  t24,0.021050776,0.025641026,0.025641026
 263  ;
 264   
 265  Prices(t,'rew')     =  - Prices(t,'rew');
 266  Prices(t,'char')    =  - Prices(t,'char');
 267  Prices(t,'dischar') =  - Prices(t,'dischar');
 268  ** define solar scenarios at all time periods
GAMS 24.8.5  r61358 Released May 10, 2017 LEX-LEG x86 64bit/Linux                                                                                                                                                                      05/09/21 13:29:41 Page 6
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
C o m p i l a t i o n


 269   
 270   
 271  * Scaling of Solar power scenarios ;
 272  scalar scale ;
 273  scale = 1;
 274  Solar(scen,t) = scale* Solar(scen,t) ;
 275  * Remove too many decimals in Solar
 276  Solar(scen,t) = round(Solar(scen,t),2) ;
 277   
 278   
 279  scalar PROBABILITY;
 280  PROBABILITY = 1/CARD(scen);
 281   
 282  scalar eta ;
 283  *from Ben paper
 284  eta = 0.9
 285  ;
 286   
 287  parameters max_store(t), min_store(t), max_charge, max_discharge;
 288   
 289   
 290  ** define tolerance threshold
 291  SCALAR threshold;
 292  threshold = floor(card(scen)*TOL)  ;
 293   
 294  parameter BigX, LowX, X_0 maximum minimum initial energy stored ;
 295  parameter BigM(scen,t) find a good BigM ;
 296   
 297  BigX = 960 ;
 298  LowX = 0.2* BigX ;
 299  X_0  = 0.5* BigX ;
 300  max_charge =  0.5* BigX ;
 301  max_discharge =  0.5* BigX ;
 302   
 303  ************** Find a Big M
 304  * find Ntol + 1st value
 305  parameter maxsolar(t), minsolar(t), dummysolar(scen,t) ;
 306  maxsolar(t) =smax(scen,solar(scen,t)) ;
 307  dummysolar(scen,t) = solar(scen,t) ;
 308   
 309  scalar it ;
 310  it = floor(card(scen)*tol) + 1;
 311   
 312  * index of it
 313  set dummy(scen);
 314  * make the dum_iter go till at least the size of it
 315  set dum_iter /dum_iter1*dum_iter100/;
 316  loop(t,
 317  loop(dum_iter$(ord(dum_iter)le it),
 318  * find the smallest solar value for this t
 319           minsolar(t) = smin(scen,dummysolar(scen,t)) ;
 320  * index of smallest solar value
 321           dummy(scen) = yes$(dummysolar(scen,t) eq minsolar(t)) ;
GAMS 24.8.5  r61358 Released May 10, 2017 LEX-LEG x86 64bit/Linux                                                                                                                                                                      05/09/21 13:29:41 Page 7
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
C o m p i l a t i o n


 322  * make the smallest solar value large
 323           dummysolar(scen,t)$dummy(scen) =maxsolar(t) ;
 324  ); );
 325  scalar G upper bound on q - p ;
 326  G = min(eta*(BigX - LowX), max_discharge) ;
 327   
 328  BigM(scen,t)= G - solar(scen,t) + minsolar(t);
 329   
 330  scalar run_time_total, start_time, end_time, LP_time, bound_time, lr_time ;
INCLUDE    /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/subgradient_parameters.gms
 332  parameter lambda;
 333  parameter ldual value of Lagrangian dual ;
 334  parameter bound total value of Lagrangian dual ;
 335  scalar init_lambda, init_bound initial value of lambda dual LP objective from LP ;
 336  *Hier werden die maximalen Iterationen, also big M festgelegt
 337  *set iter                 number of subgradient iterations /iter1*iter3/;
 338  scalar num_iter          how many iterations we did ;
 339  scalar contin            stopping             /1/;
 340  parameter stepsize;
 341  scalar theta /2/;
 342  scalar originalTheta;
 343  originalTheta=theta;
 344  scalar noimprovement /0/;
 345  scalar upperbound ;
 346  parameter gamma           subgradient          ;
 347  parameter b;
 348  parameter norm;
 349  parameter norm2;
 350  scalar lowerbound;
 351  parameter lambdaprevious, deltalambda, results(iter,*), prev_w(scen,t), prev_y(t)  ;
 352   
 353   
 354  scalar m ;
 355  parameter   y_previous(scen,t), y_average_previous(t), weight_previous(scen,t);
 356  scalar profit_orig, t1, t2, exit_tol;
 357   
 358  scalar final_gap ;
 359   
 360  parameter lb(scen) ;
 361  parameter rho(t) ;
 362   
 363  scalar exit_tol ;
 364  exit_tol = 0.00001 ;
 365   
INCLUDE    /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/equations_all.gms
 367  POSITIVE VARIABLES P(scen,t), Q(scen,t), Y(T), X(scen,t) ;
 368  VARIABLES OBJ, BOUND_LR ;
 369  BINARY VARIABLE Z(scen) ;
 370   
 371  scalar counter ;
 372   
 373  EQUATIONS
 374          Objective
GAMS 24.8.5  r61358 Released May 10, 2017 LEX-LEG x86 64bit/Linux                                                                                                                                                                      05/09/21 13:29:41 Page 8
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
C o m p i l a t i o n


 375          Const1(scen,t)    balance constraint
 376          Const2(scen,t)    max charge
 377          Const3(scen,t)    max discharge
 378          Const_chance_1(scen,t)    chance constraint big M
 379          Const_chance_PH(scen,t)
 380          Const_chance_2            chance constraint sum probabilities
 381          LR                lagrangian relaxation objective
 382          Objective_scenario(scen)
 383          Const1_scenario(scen,t)    balance constraint single scenario
 384          Const2_scenario(scen,t)    max charge    single scenario
 385          Const3_scenario(scen,t)    max discharge single scenario
 386          Const_chance_1_scenario(scen,t)    chance constraint big M  single scenario
 387           Const_chance_2_scenario(scen,t)
 388          LR_scenario(scen)
 389          LR_scenario_2(scen)
 390          LR_lb(scen)
 391          ;
 392   
 393  Objective.. OBJ=E= SUM(T,Prices(T, 'REW')*Y(T) - probability*Sum(scen, Prices(T, 'CHAR')* P(scen,t) + Prices(t, 'DISCHAR') * Q(scen,t)  ) )    ;
 394   
 395  Const1(scen,t)$(ord(t) lt card(t))..
 396           X(scen,t+1) =E= X(scen,t) + eta* P(scen,t) - (1/eta)* Q(scen,t) ;
 397  Const1_scenario(scen,t)$(ord(t) lt card(t) and (ord(scen) eq counter))..
 398           X(scen,t+1) =E= X(scen,t) + eta* P(scen,t) - (1/eta)* Q(scen,t) ;
 399   
 400   
 401  Const_chance_1(scen,t).. Y(T) + P(scen,t) -  Q(scen,t) -SOLAR(scen,t) =L= Z(scen)*BigM(scen,t) ;
 402  Const_chance_1_scenario(scen,t)$(ord(scen) eq counter)..
 403           Y(T) + P(scen,t) -  Q(scen,t) -SOLAR(scen,t) =L=0 ;
 404  Const_chance_2_scenario(scen,t)$(ord(scen) eq counter)..
 405           Y(T) + P(scen,t) -  Q(scen,t) -SOLAR(scen,t) =L= Z(scen)*BigM(scen,t) ;
 406   
 407   
 408  Const_chance_2..      - sum(scen, z(scen)) =G= -threshold;
 409   
 410  LR.. bound_lr =e=   SUM(T,Prices(T, 'REW')*Y(T) - probability*Sum(scen, Prices(T, 'CHAR')* P(scen,t) + Prices(t, 'DISCHAR') * Q(scen,t)  ) )
 411                           - lambda* (threshold - sum(scen, z(scen)))  ;
 412   
 413  Objective_scenario(scen)$(ord(scen) eq counter)..
 414           OBJ =E= SUM(T,Prices(T, 'REW')*Y(T) - Prices(T, 'CHAR')* P(scen,t) + Prices(t, 'DISCHAR') * Q(scen,t)  )     ;
 415   
 416   
 417  LR_scenario(scen)$(ord(scen) eq counter)..
 418           bound_lr =e=   SUM(T,Prices(T, 'REW')*Y(T) - (Prices(T, 'CHAR')* P(scen,t) + Prices(t, 'DISCHAR') * Q(scen,t))  )  + lambda* z(scen)/probability ;
 419  LR_scenario_2(scen)$(ord(scen) eq counter)..
 420           bound_lr =e=   SUM(T,Prices(T, 'REW')*Y(T) - (Prices(T, 'CHAR')* P(scen,t) + Prices(t, 'DISCHAR') * Q(scen,t))  )  + lambda* z(scen)/probability +
 421                                    sum(t,weight_previous(scen,t)*Y(t)) + 0.5*sum(t, rho(t)*power(y_average_previous(t) - Y(t),2)) ;
 422   
 423  LR_lb(scen)$(ord(scen) eq counter)..
 424           bound_lr =e=   SUM(T,Prices(T, 'REW')*Y(T) - (Prices(T, 'CHAR')* P(scen,t) + Prices(t, 'DISCHAR') * Q(scen,t))  )  + lambda* z(scen)/probability +
 425                                   sum(t,weight_previous(scen,t)*Y(t)) ;
 426   
 427  *** bounds on any variables
GAMS 24.8.5  r61358 Released May 10, 2017 LEX-LEG x86 64bit/Linux                                                                                                                                                                      05/09/21 13:29:41 Page 9
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
C o m p i l a t i o n


 428  x.up(scen,t) = BigX ;
 429  x.lo(scen,t) = LowX ;
 430  q.up(scen,t) = max_discharge ;
 431  p.up(scen,t) =  max_charge ;
 432  x.fx(scen,'t1') = X_0 ;
 433  z.prior(scen)   = 1;
 434   
 435   
 436  parameter last_x(scen,t), last_p(scen,t), last_q(scen,t), last_z(scen), last_ph(scen) ;
 437  ******* ALL MODELS
 438   
 439  model schedule     / Objective,  Const1, Const_chance_1, Const_chance_2/ ;
 440  model schedule_scenario     / Objective_scenario,  Const1_scenario,  Const_chance_1_scenario/ ;
 441  model INITIAL               / LR_scenario,         Const1_scenario,  Const_chance_2_scenario/ ;
 442  model Lagrangian      / LR,    Const1, Const_chance_1/ ;
INCLUDE    /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/lp_lowerbound.gms
 444  start_time = jnow ;
 445  options optca=0 ;
 446  options optcr=0 ;
 447  solve schedule using RMIP minimizing OBJ ;
****                                           $257
**** LINE      4 INCLUDE     /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/lp_lowerbound.gms
**** LINE     23 INPUT       /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/TestLoop.gms
 448  end_time =jnow ;
 449  LP_time = ghour(end_time - start_time)*3600 + gminute(end_time - start_time)*60 + gsecond(end_time - start_time);
 450  init_lambda  = Const_chance_2.m ;
****                                $141
**** LINE      7 INCLUDE     /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/lp_lowerbound.gms
**** LINE     23 INPUT       /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/TestLoop.gms
 451  lowerbound   = Obj.l ;
****                     $141
**** LINE      8 INCLUDE     /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/lp_lowerbound.gms
**** LINE     23 INPUT       /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/TestLoop.gms
 452  scalar LP_bound ;
 453  lambda       = init_lambda ;
 454  display init_lambda, LP_time, lowerbound    ;
 455  LP_bound   = Obj.l ;
INCLUDE    /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/heuristic_upperbound.gms
 457  ********************************************************************************
 458  * Find a upperbound on the problem : a feasible solution
 459  ********************************************************************************
 460   
 461  *upperbound =  0;
 462  * Find a upper bound using a fixed value and solving MIP (a feasible solution)
 463  * solve single scenario problem and choose the worst #threshold problems
 464  start_time = jnow ;
 465  schedule_scenario.solvelink = 5 ;
 466  alias(rs,scen)
 467  parameter res_scenarios(rs,*) ;
 468   
 469  loop(rs,
 470  counter = ord(rs)  ;
 471  *Solving (2) for each scenario w with corresponding z(w) = 0
GAMS 24.8.5  r61358 Released May 10, 2017 LEX-LEG x86 64bit/Linux                                                                                                                                                                     05/09/21 13:29:41 Page 10
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
C o m p i l a t i o n


 472  solve schedule_scenario using MIP minimizing Obj ;
****                                                   $257
**** LINE     16 INCLUDE     /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/heuristic_upperbound.gms
**** LINE     24 INPUT       /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/TestLoop.gms
 473  res_scenarios(rs,'obj') =obj.l ;
 474   
 475   
 476  res_scenarios(rs,'scenario') = counter ;
 477  *=counter
 478   
 479   
 480  );
 481  end_time =jnow ;
 482  run_time_total = ghour(end_time - start_time)*3600 + gminute(end_time - start_time)*60 + gsecond(end_time - start_time);
 483   
 484   
 485  ** Write to a file to sort
 486  FILE scen_sorted /scen_sorted.csv/;
 487  *.PC specifies the format of the put file: 5 -> Formatted output; non-numeric output is quoted and each item is delimited with commas.
 488  scen_sorted.PC = 5;
 489  *.ND sets the number of decimals that are displayed in the put file
 490  scen_sorted.ND = 3;
 491  PUT scen_sorted;
 492  loop(rs, put res_scenarios(rs,'scenario') put res_scenarios(rs,'obj') put /; ) ;
 493  PUTCLOSE scen_sorted;
 494   
 495   
 496  z.lo(scen) = scenario_sorted(scen,'value') ;
 497  *** Ensure file was generated correctly
 498  if ( sum(scen,z.lo(scen)) ne threshold, abort "sorted file not generated correctly check manually") ;
 499  start_time = jnow ;
 500  schedule.solprint = 0;
 501  *schedule.optfile  = 1;
 502  schedule.solvelink = 5 ;
 503  solve schedule using MIP minimizing Obj ;
****                                          $257
**** LINE     47 INCLUDE     /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/heuristic_upperbound.gms
**** LINE     24 INPUT       /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/TestLoop.gms
 504  end_time = jnow ;
 505  bound_time =  run_time_total + ghour(end_time - start_time)*3600 + gminute(end_time - start_time)*60 + gsecond(end_time - start_time);
 506  upperbound = Obj.l ;
 507  prev_y(t) = y.l(t) ;
****                $141
**** LINE     51 INCLUDE     /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/heuristic_upperbound.gms
**** LINE     24 INPUT       /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/TestLoop.gms
 508  *prev_w(scen,t) = w.l(scen,t) ;
 509   
 510  * Clear bound on z now
 511  z.up(scen) = 1 ;
 512  z.lo(scen) = 0 ;
 513   
 514  display lowerbound,upperbound,prev_y, LP_time, bound_time  ;
 515   
GAMS 24.8.5  r61358 Released May 10, 2017 LEX-LEG x86 64bit/Linux                                                                                                                                                                     05/09/21 13:29:41 Page 11
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
C o m p i l a t i o n


 516   
 517  scalar r;
 518  set indices /1*6/;
 519   
 520  File TestingFile / TestingFile.csv /;
 521  TestingFile.pc=5;
 522  TestingFile.nd=5;
 523  put TestingFile;
 524  put 'Omega', put 'Tolerance', put 'Step Size Rule', put 'Iterations', put 'Converged?', put 'Gap LR', put 'Gap Naive', put 'Obj. Naive', put 'Obj. LR', put 'Gap' put 'Time Naive', put 'Time LR' put 'Final Lambda' put/;
 525   
 526  ********************************************************************************
 527  * Solve main Problem
 528  ********************************************************************************
 529   
 530  start_time = jnow;
 531  solve schedule using MIP minimizing Obj ;
****                                          $257
**** LINE     40 INPUT       /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/TestLoop.gms
 532  end_time = jnow ;
 533   
 534   
 535   
 536  run_time_total = ghour(end_time - start_time)*3600 + gminute(end_time - start_time)*60 + gsecond(end_time - start_time);
 537   
 538  scalar ObjNaive;
 539  ObjNaive=Obj.l;
 540   
 541   
 542  scalar GapNaive;
 543  GapNaive = abs((schedule.objEst-schedule.objVal)/schedule.objEst);
 544   
 545  scalar TimeNaive;
 546  TimeNaive=run_time_total;
 547   
 548  display Obj.l, run_time_total ;
 549   
 550  ********************************************************************************
 551  * Solve the Lagrangian Dual problem now
 552  ********************************************************************************
 553   
 554  parameter ldual_iter(iter) obj function at each iteration ;
 555  lr_time = 0 ;
 556   
 557  option limrow = 0, limcol = 0, optca=0.0001, optcr=0.0001 ;
 558   
 559  prev_y(t) = y.l(t) ;
 560   
 561  parameter check(scen,t);
 562  scalar steprule;
 563  scalar FinalIter;
 564   
 565  loop(indices,
 566      lambda=init_lambda;
GAMS 24.8.5  r61358 Released May 10, 2017 LEX-LEG x86 64bit/Linux                                                                                                                                                                     05/09/21 13:29:41 Page 12
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
C o m p i l a t i o n


 567      lowerbound=LP_bound;
 568      theta=originalTheta;
 569      lr_time=0;
 570      run_time_total=0;
 571      contin=1;
 572      steprule=ord(indices);
 573   
 574      loop(iter$contin,
 575      num_iter = ord(iter) ;
 576  *         pass a warm start
 577               y.l(t) = prev_y(t) ;
 578               z.l(scen) = scenario_sorted(scen,'value') ;
 579               start_time = jnow;
 580   
 581  *********************************************************************
 582  ***Solve a Lagrangian iteration
 583  *********************************************************************
 584   
 585  *Test
 586   
INCLUDE    /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/plain_lr.gms
 588  * Plain LR solve
 589  Lagrangian.solvelink = 5;
 590  Lagrangian.optfile   = 1;
 591  solve Lagrangian using mip minimizing bound_lr  ;
****                                                  $257
**** LINE      4 INCLUDE     /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/plain_lr.gms
**** LINE     96 INPUT       /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/TestLoop.gms
 592   
 593  bound             = bound_lr.l ;
****                               $141
**** LINE      6 INCLUDE     /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/plain_lr.gms
**** LINE     96 INPUT       /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/TestLoop.gms
 594  prev_y(t)         = y.l(t) ;
 595  last_z(scen)      = z.l(scen) ;
 596   
 597  * if model is unbounded
 598  if (Lagrangian.modelstat =18,  bound = -100000000;  );
 599  results(iter,'status') = Lagrangian.modelstat;
 600   
 601      end_time = jnow ;
 602      results(iter,'time') = ghour(end_time - start_time)*3600 + gminute(end_time - start_time)*60 + gsecond(end_time - start_time);
 603      results(iter,'objective') = bound ;
 604   
INCLUDE    /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/LR_updatesMe.gms
 606  *** UPDATES FOR LAMBDA, GAMMA, THETA
 607   
 608  * Gamma update
 609  gamma =  threshold - sum(scen, last_z(scen));
 610   
 611  * Bound and theta Update -> in stepsize 6
 612  if (bound > lowerbound,
 613           lowerbound = bound;
GAMS 24.8.5  r61358 Released May 10, 2017 LEX-LEG x86 64bit/Linux                                                                                                                                                                     05/09/21 13:29:41 Page 13
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
C o m p i l a t i o n


 614           noimprovement = 0;
 615  else
 616           noimprovement = noimprovement + 1;
 617           if (noimprovement > 1,  theta = theta/2; noimprovement = 0; );
 618  );
 619   
 620  * Fix the Stepsize
 621   
INCLUDE    /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/stepsize.gms
 623  *** Different step-size updates
 624   
 625  *** Guarantees that never zero in the denominator
 626  *norm = max(abs(gamma), 1e-6);
 627  norm2 = max(gamma*gamma, 1e-6);
 628   
 629  *** constant step-size rule
 630  if(steprule=1,stepsize = 0.5;);
 631   
 632  *** constant step length
 633  if(steprule=2,stepsize = 0.5/norm2;);
 634   
 635  *** square summable but not summable
 636  if(steprule=3,stepsize = 0.5/(1+num_iter););
 637   
 638  *** nonsummable diminishing
 639  if(steprule=4,stepsize= 0.5/sqrt(num_iter););
 640   
 641  *** nonsummable diminishing step length
 642  if(steprule=5,stepsize= (1/num_iter)/norm2;);
 643   
 644  *** original
 645  if(steprule=6,stepsize=theta*(upperbound - bound)/norm2;);
 646   
 647   
 648  * Lambda Update
 649   
 650  lambdaprevious = lambda ;
 651   
 652           if (gamma ge 0 and lambdaprevious eq 0,
 653                   lambda = lambdaprevious ; );
 654           if (gamma gt 0 and lambdaprevious gt 0,
 655                   lambda = lambdaprevious - min(stepsize, lambdaprevious/gamma)*gamma ; );
 656           if (gamma le 0,
 657                   lambda = lambdaprevious - stepsize*gamma; );
 658   
 659  * Check convergence
 660  convergence=0;
 661  deltalambda = abs(lambdaprevious-lambda) ;
 662  if( deltalambda < 0.0001, contin = 0; display 'lambdas same'; convergence = 1 );
 663   
 664  * Results output
 665  results(iter,'deltalambda') = deltalambda;
 666  results(iter,'noimprov') = noimprovement;
GAMS 24.8.5  r61358 Released May 10, 2017 LEX-LEG x86 64bit/Linux                                                                                                                                                                     05/09/21 13:29:41 Page 14
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
C o m p i l a t i o n


 667  results(iter,'theta') = theta;
 668  results(iter,'step') = stepsize;
 669  results(iter,'gamma') = gamma ;
 670  results(iter,'lambda') = lambda ;
 671  results(iter,'gap') = abs((upperbound-lowerbound)/upperbound)     ; //gap is same as computed by GAMS
 672      if( ((results(iter,'gap') < exit_tol) and (num_iter > 2)),convergence=2; contin = 0;);
 673      lr_time = lr_time + results(iter,'time')   ;
 674      if (lr_time > time_limit, contin = 0 ; ) ;
 675   
 676      r=results(iter,'gap');
 677      FinalIter=num_iter;
 678  );
 679   
 680  run_time_total = LP_time + lr_time + bound_time  ;
 681   
 682  * check if any p and q active simultaneously (nothing to do with Lagrangian)
 683  *parameter check(scen,t);
 684  check(scen,t) = 0 ;
 685  check(scen,t) = 1$( p.l(scen,t) gt 0 and q.l(scen,t) gt 0) ;
 686  if ( sum((scen,t), check(scen,t)) gt 0, abort "error: p and q are one together, check. ");
 687   
 688   
 689   
 690  put TestingFile;
 691  put n, put tol, put steprule, put FinalIter, put convergence, put r, put GapNaive, put ObjNaive, put lowerbound, put ((lowerbound-ObjNaive)/ObjNaive), put TimeNaive, put lr_time put lambda put /;
 692   
 693  display results, lowerbound, upperbound, LP_bound, run_time_total, lr_time, num_iter ;
 694  display z.l, y.l ;
 695   
 696   
 697  );
 698   

**** LIST OF STRAY NAMES - CHECK DECLARATIONS FOR SPURIOUS COMMAS
**** STRAY NAME init_bound OF TYPE PARAM
**** STRAY NAME t1 OF TYPE PARAM
**** STRAY NAME t2 OF TYPE PARAM
GAMS 24.8.5  r61358 Released May 10, 2017 LEX-LEG x86 64bit/Linux                                                                                                                                                                     05/09/21 13:29:41 Page 15
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
Error Messages


141  Symbol declared but no values have been assigned. Check for missing
        data definition, assignment, data loading or implicit assignment
        via a solve statement.
        A wild shot: You may have spurious commas in the explanatory
        text of a declaration. Check symbol reference list.
257  Solve statement not checked because of previous errors
282  Unable to open include file
463  The column section in the previous table is missing

**** 11 ERROR(S)   0 WARNING(S)
GAMS 24.8.5  r61358 Released May 10, 2017 LEX-LEG x86 64bit/Linux                                                                                                                                                                     05/09/21 13:29:41 Page 16
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
Include File Summary


   SEQ   GLOBAL TYPE      PARENT   LOCAL  FILENAME

     1        1 INPUT          0       0  /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/TestLoop.gms
     2       19 INCLUDE        1      19  ./home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/inputME.gms
     3       56 INCLUDE        2      37  ../home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/scenario_sorted_100_2_01.csv
     4      236 INCLUDE        2     116  ../home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/battery_revenue.csv
     5      331 INCLUDE        1      20  ./home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/subgradient_parameters.gms
     6      366 INCLUDE        1      22  ./home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/equations_all.gms
     7      443 INCLUDE        1      23  ./home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/lp_lowerbound.gms
     8      456 INCLUDE        1      24  ./home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/heuristic_upperbound.gms
     9      587 INCLUDE        1      96  ./home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/plain_lr.gms
    10      605 INCLUDE        1     102  ./home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/LR_updatesMe.gms
    11      622 INCLUDE       10      17  ../home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/stepsize.gms


COMPILATION TIME     =        0.023 SECONDS      3 MB  24.8.5 r61358 LEX-LEG


USER: Small MUD - 5 User License                     S160825:0507AO-LNX
      Universitaet Erlangen-Nuernberg, Lehrstuhl f. WirtschaftsmaDC7699
      License for teaching and research at degree granting institutions


**** FILE SUMMARY

Input      /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/TestLoop.gms
Output     /home/hpc/mpwm/mpwm031h/bachelor-thesis/SampleRun_Environment/tol01/Scenario_2/TestLoop.lst

**** USER ERROR(S) ENCOUNTERED
